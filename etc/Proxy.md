# Proxy

## Proxy?
* 클라이언트와 서버 사이의 http 요청/응답을 중개해주는 대리인
  * 개인프록시, 하나의 클라이언트를 위한 전용 프록시
  * 공유프록시, 여러 클라이언트가 사용하는 공유되는 프록시

![image](https://user-images.githubusercontent.com/27190617/223118086-d484a11b-d1ad-443f-99ff-61940e34252a.png)

## Proxy vs Gateway?
* Proxy 는 기본적으로 같은 프로토콜을 사용하는 어플리케이션들을 연결한다
* Gateway 는 반면 다른 프로토콜을 사용하는 어플케이션들을 연결한다

하지만, 실제로 Proxy 가 확장성있게 사용되면서 둘의 실질적 차이는 모호해지고 있다

## Proxy 를 사용하는 이유

### 프록시의 역할
1. 보안 개선
2. 성능 향상
3. 비용 절약
4. 모든 http 트래픽을 제어하는 부가적 가치

### 프록시의 종류
* 웹 캐시 프록시
* 대리 프록시 (스스로 웹 서버처럼 행동하는 프록시)
* 보안 방화벽
* 트랜스코더 (데이터 표현 방식을 중간에서 자연스럽게 변환한다)
* 익명화 프록시 (개인의 보안, 클라이언트 정보를 감추기 위해 사용)

## Proxy 를 배치하는 지점
* 출구 프록시
  * LAN 과 WAN 사이를 연결
  * 특정 집단에서 사용되는 네트워크를 오가는 데이터를 제어
* 접근 프록시
  * ISP 접근지점에서 클라이언트와 WAN 사이를 연결
  * 모든 클라이언트로부터의 요청을 종합 제어할 수 있다
* 대리 프록시 (리버스 프록시)
  * 웹 서버의 앞단에 설치
  * 웹 서버로 향하는 모든 요청을 제어할 수 있다
* 네트워크 교환 프록시
  * 특정 네트워크와 네트워크 사이 라우터를 연결하는 프록시
  * 인터넷 교차로의 혼잡을 완화, 트래픽을 감시

## 트래픽을 프록시로 처리하는 방법

1. 클라이언트에서 처리
  * 브라우저등의 잘 알려진 클라이언트가 http 요청을 의도적으로 프록시 서버로 요청을 보낸다
2. 네트워크 수정
  * 네트워크 인프라 (스위치, 라우터) 등에서 가로채 의도적으로 프록시 서버로 요청을 보낸다
3. DNS 이름 공간
  * DNS 를 등록하고 DNS 에 프록시 장비를 등록한다
4. 웹 서버 수정
  * 프록시 서버로의 HTTP 리다이렉션 명령을 반환한다

## 클라이언트 Proxy 설정 방식

1. 수동으로 등록 (프록시 서버의 호스트, 포트를 지정한다)
2. PAC (프록시 자동 설정) 파일을 사용한다 (프록시 서버를 선택하는 자바스크립트 프로그램)
3. WPAD (웹 프록시 자동발견 프로토콜)
  * PAC URI 를 찾기 위해 WPAD 프로토콜을 사용한다
  * URI 에서 PAC 파일을 획득한다
  * 프록시 서버를 알아내기 위해 PAC 파일을 실행한다

## Proxy 요청의 특징

1. 클라이언트가 프록시 대신 서버로 요청을 보낼 때, 요청 uri 가 변경될 수 있다
  * 프록시는 목적 호스트, 포트를 알아야하기 때문에 완전한 uri 를 받아야함
2. 가상 호스팅
  * 가상으로 호스팅되는 웹 서버는 여러 웹사이트가 같은 물리적 웹서버를 공유한다
  * 명시적 프록시는 요청 메시지가 완전한 uri 를 갖도록 요구한다
  * 호스트와 포트에 대한 정보가 담겨있는 Host 헤더를 요구한다
3. 인터셉트 프록시는 부분 uri 를 처리
  * 클라이언트는 프록시의 존재를 모른다

## 메시지 추적

1. Via 헤더
* 메시지가 지나는 각 중간 노드마다 HTTP Via 헤더에 정보가 추가된다
* 최종적으로 서버는 메시지가 지나온 노드의 호스트명을 전부 받게 된다
* 보안상의 이유로 기록되지 않거나 여러 그룹의 노드를 하나의 노드로 통일시켜 기록할 수 있다
ex) Via: 1.1 proxy-ex-abc.com, 1.0 cache.ex.com
[protocol(http 는 생략 가능) version] [host name:port], 의 리스트를 받게 된다

2. TRACE 메서드
* 프록시를 거칠때 마다 변경되는 모든 요청 메시지를 응답 본문에 포함한다
* Max-Forwards 헤더는 TRACE 메서드와 같은 프록시 추적에서 홉의 수를 제한할 수 있다

## 프록시 인증
* 제한된 컨텐츠의 경우, 407 Proxy Authorization Required 상태 코드와 함께 인증하는 방법을 헤더 필드와 함께 반환한다
* 클라이언트가 요구되는 자격을 Proxy-Authorization 헤더 필드에 담아서 요청하면 응답이 처리된다

## 프록시 상호운용성
* 기본적으로 프록시가 이해할 수 없는 헤더 필드는 반드시 그대로 전달하며 같은 이름의 헤더 필드는 순서도 유지한다
* OPTIONS 메서드를 통해 해당 리소스가 어떤 기능(메서드)를 지원하는지 프록시가 확인할 수 있도록 해야한다
* Allow, 요청 리소스에 대해 지원되는 메서드를 열거한다
