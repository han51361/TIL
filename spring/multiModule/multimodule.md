# 멀티 모듈에 대하여 

## 멀티 모듈이란 
서로 독립적인 프로젝트(인증, 어플리케이션)를 하나의 프로젝트로 묶어 모듈로서 사용되는 구조 
- 멀티 모듈을 사용하면 공통적인 기능을 모아 하나의 모듈로 만드는 것이 가능
- 즉, 인증과 어플리케이션에서 공통으로 사용하는 `util` , `domain`, `repository` 등을 모듈로 분리해 사용할 수 있음 
- 
## 멀티 모듈 프로젝트란 
동일한 도메인에 서로 독립된 프로젝트 단위로 아래 세가지 프로젝트를 진행한다면 
- external-api  
- infra  
- batch 

> 가장 큰 문제점
> 
> 시스템의 중심 domain 이 가져야할 구조 및 규칙 등을 동일하게 보장해주는 메커니즘이 없다.  

따라서 개발자는 동일한 도메인을 가지고 있는 3가지 어플리케이션을 ctrl + c , ctrl + v 하며 개발해야 함 

### 멀티 모듈 프로젝트를 통해 귀찮음과 안전성을 보장하자
앞서 별도의 프로젝트로 관리하는 것이 아닌, 하나의 시스템에서 중심 도메인을 모듈로 분리하여 다른 모듈이 도메인에 접근하여 같은 보장 메커니즘을 제공받을 수 있도록 합니다. 
- 멀티 모듈 프로젝트는 공통으로 사용하는 코드들을 모아놓고 같이 사용할 수 있게끔 해준다. 

## 실패한 멀티 모듈 프로젝트 
공통으로 사용하는 코드들을 모은 것 모듈을 `common` 으로 지었다고 가정 

![image](https://user-images.githubusercontent.com/27190617/173220837-84da19e7-ce75-4a4b-8481-8f34a09bfa26.png)


### 공통(Common) 모듈의 저주 
- Common 모듈에는 대부분의 핵심 또는 공통되는 코드들이 모두 들어가 있게 되었을 떄 
- 다양한 어플리케이션에서 기능들이 추가되면서 공통 모듈의 크기는 계속해서 커진다. 
> 결국 어플리케이션에서 하는 일은 점점 줄어들고 공통 모듈에서 점점 더 많은 일을 하게 됨 

스파게티 코드 
- 모든 프로젝트들은 주기적인 청소가 반드시 필요하다(기능의 F/O , 리펙토링 등). 하지만 공통 모듈은 이를 방해한다. 
  - Q. 리펙토링의 영향 범위는 어디까지인가?
  - A. 시스템 전체 (코드는 결국 모두 결합도가 높아서 하나의 코드 수정은 전체가 영향받는 것이 불가피하다)
```java
class AService {
  private final ARepository aRepository;

  public A act(Long id) {
    ...
    return aRepository.findById(id);
  }
}

class BService {
  private final AService aService;

  public B act(Long id) {
    A a = aService.act(id);
    ...
    return mapToB(a);
  }
}

class CService {
  private final BService bService;

  public C act(Long id) {
    B b = bService.act(id);
    ...
    return mapToC(b);
  }
}

class DService {
  private final CService cService;

  //띠용!!
  public A act(Long id) {
    C c = cService.act(id);
    ...
    return mapToA(c);
  }
}
```

의존성 덩어리 
- 공통 모듈은 결국 전부에 대한 의존성을 갖기 마련
  - 전부가 아니더라도 프로젝트에서 사용하는 대부분의 의존성이 공통 모듈로부터 시작될 것 
- 문제는 어플리케이션들이 사용하는 의존성이 다를 수 있다. 
  - ex) DB를 사용하지 않는 어플리케이션이 공통 모듈을 위해 db와 connection을 맺게되는 의존성 
  - 결국 이거는 장애 포인트가 될 것 
![image](https://user-images.githubusercontent.com/27190617/173220850-75471dc3-a9a1-4d8a-84c2-1aa4c549e359.png)

공통 설정 
- 설정까지 공통 모듈로 몰게 되는 경우도 많이 보인다. 
- 고정적으로 공통으로 사용되어야 하는 호스트 정보 등은 경우에 따라 공통으로 보아야할 수도 있지만,
그 외의 `Thread Pool`, `Connection Pool`, `Timeout` 등의 설정도 가장 민감하고 중요한 어플리케이션 기준으로 몰아 들어가게 된다. 
  - ex) 발생하는 대표적인 문제 : DB 커넥션 
    - 최대 커넥션 개수는 고정 하지만 공통 모듈에 의한 불필요한 커넥션 발생으로 인해 장애 유발 

## 멀티 모듈 구성하기 
모듈 : 독립적으로 운영될 수 있는 의미를 가지는 구성요소 단위 
모듈의 특징 
- 모듈은 독립적인 의미를 갖는다. 
- 모듈은 어떠한 추상화 정도에 대한 계층을 지닌다. 
- 계층 간 의존 관계에 대한 규칙이 있다. 

[ 사진 ]

### 모듈의 계층 구조 
- 독립 모듈 계층
- 도메인 모듈 계층
- 내부 모듈 계층
- 공통 모듈 계층
- 어플리케이션 모듈 계층 

### 독립 모듈 계층 
- 시스템과 무관하게 어디에서나 사용가능한 라이브러리 성격의 모듈들이 배치
- 해당 계층의 모듈은 자체로서 독립적인 역할을 갖는다. 
- 해당 모듈은 프로젝트 내에 의존 관계를 두어선 안된다. 


|           | 어플리케이션 모듈 | 내부 모듈 | 도메인 모듈 | 독립 모듈 계층 | 공통 모듈 |
|-----------|-----------|-------|--------|----------|-------|
| 사용가능한모듈여부 | X         | X     | X      | X        | X     |

### 공통 모듈 계층 
- 하나의 프로젝트에서 모든 모듈에서 사용될 수 있는 것들은 나올 수 밖에 없음
- 제약 사항
  - Type, Util 등을 정의
  - 가능하면 사용하지 않는다. 
- 시스템 내 모든 모듈들이 의존할 수 있을 만큼 얇은 의존성을 제공해야하므로, 프로젝트 내 어떠한 모듈도 의존해서는 안됨

|           | 어플리케이션 모듈 | 내부 모듈 | 도메인 모듈 | 독립 모듈 계층 | 공통 모듈 |
|-----------|-----------|-------|--------|----------|-------|
| 사용가능한모듈여부 | X         | X     | X      | X        | X     |

### 도메인 모듈 계층
- 시스템의 중심 도메인을 다루는 모듈을 해당 계층에 배치 
- 내부 모듈 계층과 성격이 비슷
- 저장소와 밀접한 중심 도메인을 다루는 계층은 더욱 견고하고 특별한 관리가 필요하므로 분리 
- 원칙 
  - 서비스 비즈니스를 몰라야함
  - 하나의 모듈은 최대 하나의 infra structure에 대한 책임만 가짐 
  - 도메인 모듈을 조합한 더 큰 단위의 도메인 모듈이 존재할 수 있음 
- 해당 계층의 모듈은 프로젝트 내의 어떠한 실행 가능한 어플리케이션에서도 사용 가능해야함 
- 따라서 저장소 외의 시스템 특성을 알지 않아야하므로 내부 모듈 계층에 의존해선 X

|           | 어플리케이션 모듈 | 내부 모듈 | 도메인 모듈 | 독립 모듈 계층 | 공통 모듈 |
|-----------|-----------|-------|--------|----------|-------|
| 사용가능한모듈여부 | X         | X     | O      | O        | O     |
### 내부 모듈 계층 
- 저장소 도메인 외 시스템에서 필요한 모듈들이 존재 (시스템과는 연관이 있는 모듈들)
- 원칙 : 어플리케이션, 도메인 비즈니스를 모른다. 
- 이 계층은 시스템 전체적인 기능을 서포트하기 위한 기능 모듈이 만들어질 수 있음 
- 프로젝트 안의 어떠한 실행 가능한 어플리케이션에서도 독립 사용가능한 모듈이 위치되어야 하므로, 도메인 계층을 의존하지 X

|           | 어플리케이션 모듈 | 내부 모듈 | 도메인 모듈 | 독립 모듈 계층 | 공통 모듈  |
|-----------|-----------|-------|--------|----------|--------|
| 사용가능한모듈여부 | X         | O     | X      | O        | O      |


### 어플리케이션 모듈 계층 
- 독립적으로 실행 가능한 어플리케이션 모듈 계층
- 어플리케이션 모듈은 하위 설계 했던 모듈들을 조립하여 서비스 비즈니스를 완성시킴 

|           | 어플리케이션 모듈 | 내부 모듈 | 도메인 모듈 | 독립 모듈 계층 | 공통 모듈  |
|-----------|-----------|-------|--------|----------|--------|
| 사용가능한모듈여부 | X         | O     | O      | O        | O      |


### 모듈 계층의 의존 관계 흐름 
[사진]


## 멀티 모듈 구성 효과 

1. 명확한 추상화 관계 
   - 계층에 따라 분리된 모듈을 통해 추상화 레벨을 맞출 수 있다. 
   - 계층화된 모듈 레이어로 분리되면서 책임 선을 명확하게 할 수 있으며, 각 모듈의 영향 범위를 파악하기 용이 

2. 최소 의존성
 - 여지의 개방으로 개발 생산성을 떨어트릴 염려가 없다. 
 - Spring Boot를 사용하고 있으므로 예상치 못했거나, 불필요한 설정이 동작하는 것을 역할과 책임이 명확해진 모듈 설계를 통해 막을 수 있음 


> 출처 : https://techblog.woowahan.com/2637/